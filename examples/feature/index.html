<!DOCTYPE html>
<html xmlns:g="http://gaiajs.org/g">
<head>
    <title>g:feature example</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

    <script src="../../js/gaia.js"></script>
    <script src="js/g:feature.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>

    <link rel="stylesheet" href="bootstrap/css/bootstrap.css">
    <script src="bootstrap/js/bootstrap.js"></script>
</head>

<body gaia g:init="foo='bar'" g:feature="$Session">
    <!-- Login Modal -->
    <div g:feature="$Login" id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
            <h3 id="myModalLabel">Modal header</h3>
        </div>
        <div class="modal-body">
            <form class="form-horizontal">
                <div class="control-group">
                    <label class="control-label" for="inputEmail">Email</label>
                    <div class="controls">
                        <input type="text" id="inputEmail" placeholder="Email" g:model="user">
                    </div>
                </div>
                <div class="control-group">
                    <label class="control-label" for="inputPassword">Password</label>
                    <div class="controls">
                        <input type="password" id="inputPassword" placeholder="Password" g:model="pass">
                    </div>
                </div>
                <div class="control-group">
                    <div class="controls">
                        <label class="checkbox">
                            <input type="checkbox"> Remember me
                        </label>
                        <button type="button" class="btn" g:onclick="validate(user, pass);">Sign in</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="wrapper" g:feature="$Auth">
        <form class="form-inline">
            <div>is authorized? {{ isAuth }}</div>
            <input type="text" class="input-small" g:model="userid" placeholder="Email">
            <input type="password" class="input-small" g:model="passwd" placeholder="Password">
            <button g:onclick="auth();" class="btn" type="button">Auth! {{foo}}</button>
            <button g:onclick="requestAuth(function() {});" class="btn" type="button">request auth</button>
            <div>Status: {{ statusText }}</div>
        </form>
    </div>
    <div g:show="!!user">
        <span>user logged in as {{ user.id }}</span>
        <button g:onclick="logout()" class="btn" type="button">Logout!</button>
    </div>
</body>
<style>
    .wrapper {
        margin: 50px auto;
        width: 500px;
    }
</style>
<script>
    // user data model
    var Session = function(node) {
        var scope = this;
        scope.user = undefined;

        scope.logout = function() {
            scope.user = undefined;
            scope.$emit("logout");
        }
        scope.login = function(user, password, callback) {
            scope.$emit("login");
        }
        scope.requestAuth = function(callback) {
            authHandler && authHandler(callback);
//            scope.$emit("req.auth", callback);
        }
        var authHandler;
        scope.registerAuthHandler = function(handler) {
            authHandler = handler;
        }
    };

    var Login = function(node) {
        var callback
          , $node = $(node)
                .on('hidden', function () {
                    callback();
                });
        this.registerAuthHandler(function(handler) {
            callback = handler;
            $node.modal({
            });
        });
/*
        this.$on("req.auth", function(handler) {
            callback = handler;
            $node.modal({
            });
        });
*/
        this.validate = function(user, pass) {
            console.log("Validate user:", user, pass);
            $node.modal("hide");
        };
    }
//    Login.useParentScope = true;

    // auth controller
    var Auth = function(n) {
        var scope = this;
        scope.isAuth = false;
        scope.statusText = "not authorized";

        scope.auth = function() {
            var userid = scope.userid;
            scope.statusText = "authorizing...";
            setTimeout(function() {
                scope.statusText = "authorized [x]";
                scope.isAuth = true;
                scope.user = {
                    id: userid
                };
            }, 1000);
            console.log("-->?", scope.userid, scope.passwd);
        };
    };
</script>
</html>
