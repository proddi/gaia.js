<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <script type="text/javascript" src="../js/gaia.js"></script>
    <script type="text/javascript" src="../js/decl.js"></script>
    <script type="text/javascript" src="../js/decl/expression.js"></script>
    <script type="text/javascript" src="data.js"></script>
    <link rel="stylesheet" href="list.css">
    <title>parse me, link me, be happy!</title>
</head>
<body>
<pre>
    open console
</pre>
<script type="text/javascript">

    gaia.functions.add('time', function() {
        if (gaia.$$update) setInterval(this.$$update, 1000);
    });

var data = {
    name: "Joe",
    user: {
        name: "John Doe",
        bar: {
            arr: ["one", "two", "three"],
            obj: { foo: "bar" },
            fun: function(arg1, arg2) { return ["fun-function", arg1, arg2].join(","); },
            i: 42,
            str: "a string"
        }
    },
    fun: function(arg) { return "["+arg+"]";},
    time: function() {
        if (gaia.$$update) setInterval(gaia.$$update, 3000);
        return +new Date();
    }
};

function execute(expr, data, set) {
    var e = new Expression(expr);
    e(data, function(value) {
        console.log("~ execute.onUpdate:", '"' + e.$source + '"'," ==> ", "" + value);
    });
    if (set) {
        console.log("         +~setter~:", "(" + e(data) + ")", e.$source, "=", e.$set(data, set), "->", e(data));
    }
    return e;
}

execute("42", data);
//execute("user.name | arg(name)", data);
//execute("'user.name'", data);
//execute('"Hello $ and $!" | upper | arg(name) | arg(user.name, 42, fun("42"))', data);
//execute('fun(fun("poohh")) | upper', data);
//execute('time()', data);
execute('user.bar.obj|json', data);
execute('["foo", user.bar["str"]|upper]|upper', data);
execute('["foo", "str"][2]', data);

execute('user.bar.fun | json', data);
window.foo = new Date();
execute('user.bar.fun | json', data, "muh");
execute('user.bar.fun | json', data);
</script>
</body>
</html>
