<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
	<title>Insert title here</title>
    <script type="text/javascript" src="../js/dbs.js"></script>
    <script type="text/javascript" src="../js/decl.js"></script>
    <script type="text/javascript" src="../js/decl/widgets/repeat.js"></script>
    <script type="text/javascript" src="../js/decl/widgets/data.js"></script>
    <script type="text/javascript" src="../js/decl/widgets/bind.js"></script>
    <script type="text/javascript" src="../js/decl/widgets/text.js"></script>
    <script type="text/javascript" src="../js/decl/widgets/template.js"></script>
    <style>
        *[template] {
            opacity: .33;
        }
        h2 {
            margin: 16px 0 8px 0;
            border-bottom: 2px solid #888;
            background: #DDD;
        }
    </style>
</head>
<body decl>

	<div data="dbs" source="=loadData();" refresh="20" orderBy="age"></div>

    <h2>Repeating atom without binding (var b) - simple template</h2>
    <ul>
        <li repeat="a in $b=[1,2,3,4,5]" text="a"></li>
    </ul>

    <h2>Repeating atom without binding (var b) - complex template</h2>
    <ul>
        <li repeat="a in $b=[1,2,3,4,5]">
            #<span text="a"></span>
        </li>
    </ul>

    <h2>Repeating object without binding (var b) - simple template</h2>
    <ul>
        <li repeat="a in $b=[{name:'Klaus',age:45}, {name:'Adam',age:25}, {name:'Helen',age:31}, {name:'Silver',age:54}]" bind="a.name" use="template1" scope="a_scope"></li>
    </ul>

    <h2>Repeating object without binding (var b) - complex template</h2>
    <ul>
        <li repeat="a in b">
            <span bind="a.name"></span>, <span text="a.age"></span>
        </li>
    </ul>

    <h2>Repeat in select (var c)</h2>
    <select>
        <option repeat="o in $c=['Hans', 'Dieter', 'Wurst']" text="o"></option>
    </select>

    <h2>Controller</h2>
    <div useController="a_controller as ctrl">
        <span text="$navigator.userAgent"></span>
    </div>

    <h2>Template definitions</h2>
    <li template="template1">
        <span bind="a.name"></span>, <span bind="a.age"></span> (template)
    </li>
    <div template="template2">
        template<span>*2*</span>
    </div>

<script>
    function extractChildren(parent, nodes) {
        function isParent(node, parent) {
            while (node = node.parentNode) {
                if (parent === node) return true;
            }
        }
        for (var i = 0, l = nodes.length; i < l; i++) {
            if (isParent(nodes[i], parent)) continue;
            break;
        }
        var children = nodes.slice(0, i);
        nodes.splice(0, i);
        return children;
    }

var widgets = {
    watch: function(node) {
        console.log("watch", node);
    },
    repeat: function(node, nodes) {
        var attrib = node.getAttribute("repeat");
        node.removeAttribute("repeat");

        var parent = node.parentNode;
        parent.removeChild(node);

        var match = attrib.match(/^(\w*) in (.*)$/);
        // console.log("widget->repeat()", attrib, match);
        if (!match || match.length !== 3) {
            throw new Error("repeat needs 'x in y'");
        }

        var data = match[1],
            dataSet = decl.solve(window, match[2]);

        dataSet = decl._prepareArray(dataSet);

        // extract definition
        // clone and apply definition
        for ( var i = 0, l = dataSet.length; i < l; i++) {
            this[data] = dataSet[i];
            var clone = node.cloneNode(true);
            decl.compile.call(this, clone, this);
            parent.appendChild(clone);
        }

        // isolate own children to (might) proceed different
//        var own = extractChildren(node, nodes);
        return true; // don't proceed on this node again
    },
    template: function(node) {
//        console.log("template", node);
    },
    eval: function(node) {
//        console.log("eval", node);
    },
    bind: function(node) {
        var attrib = node.getAttribute("bind");
        node.removeAttribute("bind");

        var bind = decl.solveBind(this, attrib);
        // bind only if its an object. no binding on single atoms or expressions (yet)
        if (bind[0]) {
            decl.watch(bind[0], bind[1], function(value) {
                node.innerText = value;
            });
        } else {
            console.warn("Ignore bind - cannot bind to single value, object needed.");
        }

        node.innerText = bind[2];
    },
    text: function(node) {
        var attrib = node.getAttribute("text");
        node.removeAttribute("text");
        node.innerText = decl.solve(this, attrib);
    }
};

/**
 * Compile node including children.
 */
decl.compile = function(node, scope) {
    // query nodes as array
    var nodes;
    if (node.parentNode) {
        nodes = node.querySelectorAll("[template],[repeat],[eval],[bind],[watch],[text]");
    } else {
        parent = document.createElement("div");
	    parent.appendChild(node);
        nodes = parent.querySelectorAll("[template],[repeat],[eval],[bind],[watch],[text]");
        parent.removeChild(node);
    }
    nodes = (function(nodes) {
        for (var i = 0, l = nodes.length, res = new Array(l); i<l; i++) res[i] = nodes[i];
        return res;
    })(nodes);

    for (; (node = nodes.shift());) {
        for (var name in widgets) {
            if (node.hasAttribute(name)) {
                if (widgets[name].call(this, node, nodes)) break;
            }
        }
    }
}
</script>

</body>
</html>